name: WB Auto-Updater

on:
  push:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Check for Updates
        id: check_version
        run: |
          PACKAGE_NAME="ru.wb.courier"
          RUSTORE_JSON=$(curl -s "https://backapi.rustore.ru/applicationData/overallInfo/$PACKAGE_NAME")
          LATEST_VER=$(echo "$RUSTORE_JSON" | jq -r '.body.versionName')
          
          echo "RuStore version: $LATEST_VER"

          CURRENT_VER=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name | sed 's/v//')
          
          if [ "$CURRENT_VER" == "null" ]; then CURRENT_VER="0.0.0"; fi
          echo "GitHub version: $CURRENT_VER"

          if [ "$LATEST_VER" == "$CURRENT_VER" ]; then
            echo "–í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "–ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_VER" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Dependencies & Tools
        if: steps.check_version.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm install
          wget -L -nv https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar -O apktool.jar
          wget -q https://github.com/patrickfav/uber-apk-signer/releases/download/v1.3.0/uber-apk-signer-1.3.0.jar -O signer.jar

      - name: Restore Keystore
        if: steps.check_version.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release-key.jks

      - name: Run Builder
        if: steps.check_version.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        env:
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: npm start

      - name: Create Release
        if: steps.check_version.outputs.update_needed == 'true' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check_version.outputs.version }}
          name: WB Mod v${{ steps.check_version.outputs.version }}
          files: wb-mod-final.apk
          body: |
            ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ RuStore
            
            –í–µ—Ä—Å–∏—è: **${{ steps.check_version.outputs.version }}**
            
            –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ:
            - API Proxy (Profit Engine)